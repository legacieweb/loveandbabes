<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sign Up - LoveConnect</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-pink-50 text-gray-800">

  <!-- Header -->
  <header class="bg-white shadow-md">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-pink-600">LoveConnect</h1>
      <a href="login.html" class="text-gray-700 hover:text-pink-600 font-semibold">Login</a>
    </div>
  </header>

  <!-- Sign Up Form -->
  <section class="flex items-center justify-center min-h-screen px-4 py-10">
    <div class="w-full max-w-2xl bg-white p-8 rounded-lg shadow-md">
      <h2 class="text-2xl font-bold mb-6 text-center">Create Your Profile</h2>
      <form class="space-y-5">

        <!-- Image Upload with Camera Capture and Remove -->
        <div class="flex flex-col items-center space-y-3">
          <div id="image-preview" class="w-32 h-32 rounded-full border border-gray-300 bg-gray-100 flex items-center justify-center text-sm text-gray-500 overflow-hidden shadow">
            No image
          </div>
          <input type="file" accept="image/*" class="hidden" id="fileInput" onchange="previewImage(event)">
          <div class="flex gap-2">
            <button type="button" onclick="document.getElementById('fileInput').click()" class="px-4 py-2 bg-pink-100 text-pink-700 rounded hover:bg-pink-200">Upload</button>
            <button type="button" onclick="openCamera()" class="px-4 py-2 bg-pink-600 text-white rounded hover:bg-pink-700">Take Photo</button>
            <button type="button" onclick="removeImage()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Remove</button>
          </div>
        </div>

        <!-- Camera Modal -->
        <div id="cameraModal" class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 hidden">
          <div class="bg-white rounded-lg p-4 space-y-4 max-w-sm w-full text-center">
            <video id="camera" autoplay playsinline class="w-full rounded"></video>
            <div class="flex justify-center gap-4">
              <button onclick="takePhoto()" class="bg-pink-600 text-white px-4 py-2 rounded hover:bg-pink-700">📸 Capture</button>
              <button onclick="closeCamera()" class="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
            </div>
            <canvas id="canvas" class="hidden"></canvas>
          </div>
        </div>

        <!-- Basic Info -->
        <input type="text" placeholder="Profile Name" class="w-full p-3 border rounded" required>
        <input type="text" placeholder="Full Name" class="w-full p-3 border rounded" required>
<input type="date" id="birthDate" class="w-full p-3 border rounded" required />
        <input type="email" placeholder="Email Address" class="w-full p-3 border rounded" required>
        <input type="password" placeholder="Create Password" class="w-full p-3 border rounded" required>

        <!-- Gender -->
        <select class="w-full p-3 border rounded" required>
          <option disabled selected>Choose Your Gender</option>
          <option>Female</option>
          <option>Male</option>
          <option>Non-Binary</option>
          <option>Transgender</option>
          <option>Genderqueer</option>
          <option>Agender</option>
          <option>Two-Spirit</option>
          <option>Other</option>
          <option>Prefer not to say</option>
        </select>

        <!-- Interested In -->
        <div>
          <select class="w-full p-3 border rounded" required>
            <option disabled selected>Interested In (Gender Preferences)</option>
            <option>Women 👩</option>
            <option>Men 👨</option>
            <option>Non-Binary / Genderqueer 🌈</option>
            <option>Trans Women 🧕</option>
            <option>Trans Men 🧔</option>
            <option>All Genders 🌀</option>
            <option>Still figuring it out 🤔</option>
            <option>Prefer not to say 🙊</option>
          </select>
          <p class="text-xs text-gray-500 mt-1">This helps us match you with your ideal partners 💘</p>
        </div>

        <!-- Relationship Type -->
        <select class="w-full p-3 border rounded" required>
          <option disabled selected>Relationship Type</option>
          <option>Looking for a serious relationship 💍</option>
          <option>Something casual but meaningful 🤝</option>
          <option>Just friends (or... maybe more 😉)</option>
          <option>Open relationship / ethically non-monogamous 🔄</option>
          <option>Here for a good time, not a long time 😏</option>
          <option>One-night stand, being honest about it 🌙🔥</option>
          <option>Friends with benefits — emphasis on benefits 🍑</option>
          <option>No strings attached, zero drama 🚫🎭</option>
          <option>Let’s vibe and see what happens 🎶</option>
          <option>I’m just bored and curious 👀</option>
          <option>Prefer not to say 🙊</option>
        </select>

        <!-- Sexual Orientation -->
        <select class="w-full p-3 border rounded">
          <option disabled selected>Sexual Orientation</option>
          <option>Straight</option>
          <option>Gay</option>
          <option>Lesbian</option>
          <option>Bisexual</option>
          <option>Pansexual</option>
          <option>Asexual</option>
          <option>Queer</option>
          <option>Questioning</option>
          <option>Prefer not to say</option>
        </select>

        <!-- Sexual Preferences -->
        <select class="w-full p-3 border rounded">
          <option disabled selected>Sexual Interests / Preferences (Optional)</option>
          <option>Romantic and sensual</option>
          <option>Kinky / BDSM</option>
          <option>Dominant</option>
          <option>Submissive</option>
          <option>Experimenting</option>
          <option>Open to fantasies</option>
          <option>Prefer not to say</option>
        </select>

        <!-- Lifestyle -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <select class="w-full p-3 border rounded">
            <option disabled selected>Do you smoke?</option>
            <option>No</option>
            <option>Occasionally</option>
            <option>Yes</option>
            <option>Trying to quit</option>
          </select>
          <select class="w-full p-3 border rounded">
            <option disabled selected>Do you drink?</option>
            <option>No</option>
            <option>Socially</option>
            <option>Frequently</option>
            <option>Prefer not to say</option>
          </select>
        </div>

        <!-- Love Language -->
        <select class="w-full p-3 border rounded">
          <option disabled selected>Primary Love Language</option>
          <option>Words of affirmation</option>
          <option>Physical touch</option>
          <option>Quality time</option>
          <option>Acts of service</option>
          <option>Gift-giving</option>
        </select>

        <!-- User Location -->
        <div class="space-y-2">
          <input type="text" id="country" placeholder="Country" class="w-full p-3 border rounded" required />
          <input type="text" id="state" placeholder="State / Region" class="w-full p-3 border rounded" required />
          <input type="text" id="district" placeholder="City / District" class="w-full p-3 border rounded" required />
          <button type="button" onclick="getFullLocation()" class="w-full md:w-auto bg-pink-100 text-pink-700 px-4 py-2 rounded hover:bg-pink-200 text-sm">Use My Location</button>
          <p class="text-xs text-gray-500 mt-1">Allow location access to auto-fill your area details for better matches.</p>
        </div>

        <!-- Submit -->
        <button id="signup-btn" type="button" onclick="submitForm()" class="w-full bg-pink-600 text-white py-3 rounded hover:bg-pink-700">
          verify email
        </button>
      </form>

      <!-- Verification Code Section -->
      <div id="verify-section" class="hidden space-y-3 mt-6">
        <h3 class="text-lg font-semibold">Enter Verification Code</h3>
        <input type="text" id="verify-code" maxlength="6" placeholder="Enter 6-digit code" class="w-full p-3 border rounded" />
<button id="verify-btn" onclick="submitCode()" class="w-full bg-green-600 text-white py-3 rounded hover:bg-green-700">Verify</button>
        <p id="verify-status" class="text-sm text-gray-600 mt-1"></p>
      </div>

      <p class="text-center text-sm mt-4">Already have an account? 
        <a href="login.html" class="text-pink-600 hover:underline">Login</a>
      </p>
    </div>
  </section>

<script>
  let stream;

  function previewImage(event) {
    const preview = document.getElementById('image-preview');
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        preview.innerHTML = `<img src="${reader.result}" class="w-full h-full object-cover" alt="Profile Image" />`;
      };
      reader.readAsDataURL(file);
    } else {
      preview.innerHTML = 'No image';
    }
  }

  function openCamera() {
    const modal = document.getElementById('cameraModal');
    const video = document.getElementById('camera');

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(mediaStream => {
        stream = mediaStream;
        video.srcObject = mediaStream;
        modal.classList.remove('hidden');
      })
      .catch(err => {
        alert("Camera access denied or unavailable.");
        console.error(err);
      });
  }

  function closeCamera() {
    const modal = document.getElementById('cameraModal');
    const video = document.getElementById('camera');
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
    video.srcObject = null;
    modal.classList.add('hidden');
  }

  function takePhoto() {
    const video = document.getElementById('camera');
    const canvas = document.getElementById('canvas');
    const preview = document.getElementById('image-preview');

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);

    const imageUrl = canvas.toDataURL('image/png');
    preview.innerHTML = `<img src="${imageUrl}" class="w-full h-full object-cover rounded-full" alt="Captured Image" />`;

    closeCamera();
  }


  function removeImage() {
  const preview = document.getElementById('image-preview');
  document.getElementById('fileInput').value = '';
  preview.innerHTML = 'No image';
}

async function getFullLocation() {
  if (!navigator.geolocation) {
    alert("Geolocation not supported.");
    return;
  }

  navigator.geolocation.getCurrentPosition(async position => {
    const { latitude, longitude } = position.coords;

    try {
      const response = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json`);
      const data = await response.json();
      const address = data.address;

      // 🌍 Extract Country & State
      document.getElementById('country').value = address.country || '';
      document.getElementById('state').value = address.state || address.region || '';

      // 🏘️ Extract District/City-Level Detail
      const district =
        address.suburb ||
        address.neighbourhood ||
        address.city_district ||
        address.county ||
        address.town ||
        address.village ||
        address.city ||
        '';

      document.getElementById('district').value = district;

    } catch (error) {
      console.error("Location fetch error:", error);
      alert("Unable to fetch address from location.");
    }

  }, err => {
    alert("Location access denied or unavailable.");
    console.error(err);
  });
}

async function submitForm() {
  const signupBtn = document.getElementById("signup-btn");
  signupBtn.disabled = true;
  signupBtn.textContent = "Sending...";

  const emailInput = document.querySelector('input[placeholder="Email Address"]');
  const email = emailInput?.value?.trim();

  if (!email || !email.includes("@")) {
    alert("Please enter a valid email.");
    signupBtn.disabled = false;
    signupBtn.textContent = "Sign Up";
    return;
  }

  try {
    const res = await fetch("http://localhost:3000/send-verification", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ email })
    });

    const data = await res.json();

    if (data.success) {
      document.getElementById("verify-section").classList.remove("hidden");
      alert("✅ Verification code sent to your email.");
    } else {
      alert("❌ Failed to send email: " + (data.message || "Unknown error"));
    }
  } catch (err) {
    console.error("❌ Email send error:", err);
    alert("❌ Server error while sending email.");
  }

  signupBtn.disabled = false;
  signupBtn.textContent = "Sign Up";
}

async function submitCode() {
  const verifyBtn = document.getElementById("verify-btn");
  const code = document.getElementById("verify-code").value.trim();
  const status = document.getElementById("verify-status");

  verifyBtn.disabled = true;
  verifyBtn.textContent = "Verifying...";

  if (!code || code.length !== 6 || !/^\d+$/.test(code)) {
    status.textContent = "❌ Enter a valid 6-digit code.";
    status.classList.remove("text-green-600");
    status.classList.add("text-red-600");
    verifyBtn.disabled = false;
    verifyBtn.textContent = "Verify";
    return;
  }

  const imageElement = document.getElementById("image-preview").querySelector("img");
  const birthDateInput = document.getElementById("birthDate").value;
  const birthDate = new Date(birthDateInput);
  const birthYear = birthDate.getFullYear();

  if (!birthDateInput || isNaN(birthYear) || birthYear < 1900 || birthYear > new Date().getFullYear()) {
    status.textContent = "❌ Please enter a valid birth date.";
    status.classList.remove("text-green-600");
    status.classList.add("text-red-600");
    verifyBtn.disabled = false;
    verifyBtn.textContent = "Verify";
    return;
  }

  const userData = {
    profileName: document.querySelector('input[placeholder="Profile Name"]').value,
    fullName: document.querySelector('input[placeholder="Full Name"]').value,
    email: document.querySelector('input[placeholder="Email Address"]').value,
    password: document.querySelector('input[placeholder="Create Password"]').value,
    gender: document.querySelector('select[required]').value,
    interestedIn: document.querySelectorAll('select')[1].value,
    relationshipType: document.querySelectorAll('select')[2].value,
    orientation: document.querySelectorAll('select')[3].value,
    sexualPreference: document.querySelectorAll('select')[4].value,
    smoke: document.querySelectorAll('select')[5].value,
    drink: document.querySelectorAll('select')[6].value,
    loveLanguage: document.querySelectorAll('select')[7].value,
    country: document.getElementById("country").value,
    state: document.getElementById("state").value,
    district: document.getElementById("district").value,
    image: imageElement ? imageElement.src : "",
    birthDate: birthDateInput,
    year: birthYear
  };

  try {
    const res = await fetch("http://localhost:3000/verify-code", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ code, userData })
    });

    const contentType = res.headers.get("content-type");

    if (!res.ok || !contentType || !contentType.includes("application/json")) {
      const fallbackText = await res.text();
      console.error("⚠️ Unexpected response:", fallbackText);
      status.textContent = "❌ Server error. Please try again.";
      status.classList.remove("text-green-600");
      status.classList.add("text-red-600");
      verifyBtn.disabled = false;
      verifyBtn.textContent = "Verify";
      return;
    }

    const data = await res.json();

    if (data.success) {
      status.textContent = "✅ Verified successfully! Redirecting...";
      status.classList.remove("text-red-600");
      status.classList.add("text-green-600");

      localStorage.setItem("user_email", userData.email);

      const likedEmail = localStorage.getItem("liked_email");
      if (likedEmail) {
        try {
          await fetch("http://localhost:3000/user/like", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ liker: userData.email, liked: likedEmail })
          });
        } catch (likeErr) {
          console.error("❌ Failed to send like after signup:", likeErr);
        }
        localStorage.removeItem("liked_email");
      }

      setTimeout(() => {
        window.location.href = "dashboard.html";
      }, 1500);
    } else {
      status.textContent = "❌ Incorrect or expired verification code.";
      status.classList.remove("text-green-600");
      status.classList.add("text-red-600");
      verifyBtn.disabled = false;
      verifyBtn.textContent = "Verify";
    }

  } catch (err) {
    console.error("❌ Submit code error:", err);
    status.textContent = "❌ Network error. Please try again.";
    status.classList.remove("text-green-600");
    status.classList.add("text-red-600");
    verifyBtn.disabled = false;
    verifyBtn.textContent = "Verify";
  }
}
</script>

</body>
</html>
